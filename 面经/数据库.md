# 数据库

## 1、数据库索引

首先索引是帮助数据库高效获取数据的**数据结构**。由于数据库需要经常性地做大量的查询操作，因此我们需要设计高效的查找算法以提高数据库查询数据的速度。常见的查找算法有顺序查找、二分查找以及二叉查找树查找等，顺序查找的查找效率显然是很低的，而二分查找和二叉查找树查找这种相对高效的算法只能应用于特定的数据结构上。然而实际数据的组织结构不可能完全满足各种特定的查找算法的要求。为此，数据库在数据之外维护着满足特定查找算法的数据结构，这个数据结构就是数据库索引。

目前大部分数据库都采用 B+ 树作为索引的数据结构。在 B+ 树中，一个树节点包含多个 key 和多个指向下一个树节点的指针。一个树节点中 key 和 指针交替出现并且 key 从左到右非递减排列。如果某个指针的左右相邻 key 分别是 key1 和 key2，则该指针指向节点的所有 key 大于等于 key1 且 小于等于 key2。B+ 树的叶节点具有相同的深度，也就是说它们都处在同一层，并且叶节点除了存储 key 外，还存储数据记录的其他信息。相邻的叶节点通常通过指针连接起来以提高区间访问的性能。

[MySQL索引背后的数据结构及算法](https://www.kancloud.cn/kancloud/theory-of-mysql-index/41846)

## 2、数据库索引为什么使用 B+ 树而不使用红黑树

红黑树等平衡树也可以用来实现索引，但是文件系统及数据库系统普遍采用 B+ Tree 作为索引结构，主要有以下两个原因：

（一）更少的查找次数

平衡树查找操作的时间复杂度和树高 h 相关，O(h)=O(logdN)，其中 d 为每个节点的出度。

红黑树的出度为 2，而 B+ Tree 的出度一般都非常大，所以红黑树的树高 h 很明显比 B+ Tree 大非常多，查找的次数也就更多。

（二）利用磁盘预读特性

为了减少磁盘 I/O 操作，磁盘往往不是严格按需读取，而是每次都会预读。预读过程中，磁盘进行顺序读取，顺序读取不需要进行磁盘寻道，并且只需要很短的旋转时间，速度会非常快。

操作系统一般将内存和磁盘分割成固定大小的块，每一块称为一页，内存与磁盘以页为单位交换数据。数据库系统将索引的一个节点的大小设置为页的大小，使得一次 I/O 就能完全载入一个节点。并且可以利用预读特性，相邻的节点也能够被预先载入 (**我理解的是如果 B+ 树中相邻的两个叶节点在一页中，那么当读取第一个叶节点的时候利用磁盘预读也会读取第二个叶节点**)。

[MySQL](https://cyc2018.github.io/CS-Notes/#/notes/MySQL?id=%E5%85%AD%E3%80%81%E5%A4%8D%E5%88%B6)

## 3、MySQL 索引优化

### 索引的最左匹配特性

当 B+ 树的数据项是复合的数据结构，比如 (name, age, sex) 的时候，B+ 数是按照从左到右的顺序来建立搜索树的，比如当 (张三, 20, F) 这样的数据来检索的时候，B+ 树会优先比较 name 来确定下一步的所搜方向，如果 name 相同再依次比较 age 和 sex，最后得到检索的数据；但当 (20, F) 这样的没有 name 的数据来的时候，B+ 树就不知道下一步该查哪个节点，因为建立搜索树的时候 name 就是第一个比较因子，必须要先根据 name 来搜索才能知道下一步去哪里查询。比如当 (张三, F) 这样的数据来检索时，B+树可以用 name 来指定搜索方向，但下一个字段 age 的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是 F 的数据了， 这个是非常重要的性质，即索引的最左匹配特性。

### 建索引的几大原则

#### 1. 最左前缀匹配原则

对于多列索引，总是从索引的最前面字段开始，接着往后，中间不能跳过。比如创建了多列索引 (name, age, sex)，会先匹配 name 字段，再匹配 age 字段，再匹配 sex 字段的，中间不能跳过。mysql 会一直向右匹配直到遇到范围查询 (>、<、between、like)就停止匹配。

**一般，在创建多列索引时，where 子句中使用最频繁的一列放在最左边。**

#### 2. 尽量选择区分度高的列作为索引

比如，我们会选择学号做索引，而不会选择性别来做索引。

#### 3. = 和 in 可以乱序

比如a = 1 and b = 2 and c = 3，建立(a,b,c)索引可以任意顺序，mysql 的查询优化器会帮你优化成索引可以识别的形式。

#### 4. 索引列不能参与计算 (也不能是函数的参数)，保持列“干净”

比如：Flistid + 1 > ‘2000000608201108010831508721‘，这样将无法使用索引。

#### 5. 尽量扩展索引，不要新建索引

比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。

### 索引的不足

虽然索引可以提高查询效率，但索引也有自己的不足之处。

索引的额外开销：

(1) 空间：索引需要占用空间；

(2) 时间：查询索引需要时间；

(3) 维护：索引须要维护（数据变更时）；

不建议使用索引的情况：

(1) 数据量很小的表

(2) 空间紧张

[MySQL 索引及查询优化总结](https://cloud.tencent.com/developer/article/1004912)